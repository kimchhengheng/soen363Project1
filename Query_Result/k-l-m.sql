--K
-- K 1
SELECT  CA.TOM, COUNT(*)
FROM   (SELECT DISTINCT A1.NAME AS TOM, A2.NAME
        FROM MOVIES M, ACTORS A1, ACTORS A2
        WHERE A1.NAME = 'Tom Cruise' AND A1.MID = M.MID AND A2.MID=M.MID AND A2.NAME <> A1.NAME) CA
GROUP BY CA.TOM;

-- K 2
CREATE VIEW NUM_COACTORS_PER_ACTOR AS
SELECT CA.MAIN_ACTOR, COUNT(*) AS NUM_CA     
FROM   (SELECT DISTINCT A1.NAME AS MAIN_ACTOR, A2.NAME
        FROM MOVIES M, ACTORS A1, ACTORS A2
        WHERE A1.MID = M.MID AND A2.MID=M.MID AND A2.NAME <> A1.NAME) CA 
GROUP BY CA.MAIN_ACTOR;

SELECT *
FROM NUM_COACTORS_PER_ACTOR
WHERE NUM_CA = (SELECT MAX(NUM_CA) FROM NUM_COACTORS_PER_ACTOR)
ORDER BY MAIN_ACTOR ASC;

-- L
-- SMITH MOVIE STATS VIEW
CREATE VIEW SMITH_MOVIE_STAT AS
SELECT COUNT(DISTINCT A.NAME) AS CA, COUNT(DISTINCT T.TID) AS CT, COUNT(DISTINCT G.GENRE) AS CG, M.YEAR AS YEAR, M.RATING AS RATING   
FROM ACTORS A, MOVIES M, TAGS T, GENRES G
WHERE M.TITLE = 'Mr. \& Mrs. Smith' AND A.MID = M.MID AND T.MID = M.MID AND G.MID = M.MID
GROUP BY YEAR, RATING;

-- VIEWS FOR CALCULATING FRACTION OF COMMON ACTORS
CREATE VIEW NUM_COMMON_ACTORS AS
SELECT M2.MID, COUNT(DISTINCT A1.NAME) AS NCA
FROM MOVIES M1, MOVIES M2, ACTORS A1, ACTORS A2
WHERE M1.TITLE = 'Mr. \& Mrs. Smith' AND M2.TITLE <> 'Mr. \& Mrs. Smith' AND A1.NAME = A2.NAME AND A1.MID = M1.MID AND A2.MID = M2.MID
GROUP BY M2.MID;

CREATE VIEW NOT_COMMON_MOVIES_ACTORS AS
SELECT M.MID, 0 AS NCA
FROM MOVIES M
WHERE M.TITLE <> 'Mr. \& Mrs. Smith' AND M.MID NOT IN (SELECT M1.MID FROM NUM_COMMON_ACTORS M1);

CREATE VIEW ALL_NCA AS
SELECT * FROM NUM_COMMON_ACTORS
UNION
SELECT * FROM NOT_COMMON_MOVIES_ACTORS;

-- VIEWS FOR CALCULATING FRACTION OF COMMON TAGS
CREATE VIEW NUM_COMMON_TAGS AS
SELECT M2.MID, COUNT(DISTINCT T1.TID) AS NCT
FROM MOVIES M1, MOVIES M2, TAGS T1, TAGS T2
WHERE M1.TITLE = 'Mr. \& Mrs. Smith' AND M2.TITLE <> 'Mr. \& Mrs. Smith' AND T1.TID = T2.TID AND T1.MID = M1.MID AND T2.MID = M2.MID
GROUP BY M2.MID;

CREATE VIEW NOT_COMMON_MOVIES_TAGS AS
SELECT M.MID, 0 AS NCT
FROM MOVIES M
WHERE M.TITLE <> 'Mr. \& Mrs. Smith' AND M.MID NOT IN (SELECT M1.MID FROM NUM_COMMON_TAGS M1);

CREATE VIEW ALL_NCT AS
SELECT * FROM NUM_COMMON_TAGS
UNION
SELECT * FROM NOT_COMMON_MOVIES_TAGS;

-- VIEWS FOR CALCULATING FRACTION OF COMMON GENRES
CREATE VIEW NUM_COMMON_GENRES AS
SELECT M2.MID, COUNT(DISTINCT G2.GENRE) AS NCG
FROM MOVIES M1, MOVIES M2, GENRES G1, GENRES G2
WHERE M1.TITLE = 'Mr. \& Mrs. Smith' AND M2.TITLE <> 'Mr. \& Mrs. Smith' AND M1.MID <> M2.MID AND G1.GENRE = G2.GENRE AND G1.MID = M1.MID AND G2.MID = M2.MID
GROUP BY M2.MID;

CREATE VIEW NOT_COMMON_MOVIES_GENRES AS
SELECT M.MID, 0 AS NCG
FROM MOVIES M
WHERE M.TITLE <> 'Mr. \& Mrs. Smith' AND M.MID NOT IN (SELECT M1.MID FROM NUM_COMMON_GENRES M1);

CREATE VIEW ALL_NCG AS
SELECT * FROM NUM_COMMON_GENRES
UNION
SELECT * FROM NOT_COMMON_MOVIES_GENRES;

-- CENTRALIZING ALL FRACTIONS DATA OF MOVIES
CREATE VIEW FRACTION_TABLE AS
SELECT M.MID, (NCA.NCA/SMS.CA) AS FCA, (NCT.NCT/SMS.CT) AS FCT, (NCG.NCG/SMS.CG) AS FCG, (1-(ABS(M.YEAR-SMS.YEAR)/GREATEST(M.YEAR,SMS.YEAR))) AS AGE_GAP, (1-(ABS(M.RATING-SMS.RATING)/GREATEST(M.RATING,SMS.RATING))) AS RATING_GAP         
FROM MOVIES M, ALL_NCA NCA, ALL_NCT NCT, ALL_NCG NCG, SMITH_MOVIE_STAT SMS
WHERE M.TITLE <> 'Mr. \& Mrs. Smith' AND NCA.MID = M.MID AND NCT.MID = M.MID AND NCG.MID = M.MID AND M.RATING IS NOT NULL;

-- FINAL QUERY
SELECT * FROM (
SELECT DISTINCT M.TITLE, M.RATING, ((FT.FCA + FT.FCT + FT.FCG + FT.AGE_GAP + FT.RATING_GAP)*20) AS SIM_SCORE
FROM MOVIES M, FRACTION_TABLE FT
WHERE M.MID = FT.MID
ORDER BY SIM_SCORE DESC)
WHERE ROWNUM <= 10;

-- M
-- FINDING OUT WHICH TABLES HAVE DUPLICATES
-- ASSUMPTION: TO FIND THE DUPLICATES, WE ARE CONSIDERING ALL ATTRIBUTES EXCEPT THE PRIMARY KEY WHERE IT WAS DEFINED
-- IF THE RETURN RESULT SET IS NOT EMPTY, IT MEANS THERE ARE DUPLICATE ROWS

-- ACTORS HAS NO DUPLICATES
SELECT MID, NAME, CAST_POSITION
FROM ACTORS
GROUP BY MID, NAME, CAST_POSITION
HAVING COUNT(*) > 1;

-- MOVIES HAS DUPLICATES
SELECT TITLE, YEAR, RATING, NUM_RATING
FROM MOVIES
GROUP BY TITLE, YEAR, RATING, NUM_RATING
HAVING COUNT(*) > 1;

-- GENRES HAS NO DUPLICATES
SELECT MID, GENRE
FROM GENRES
GROUP BY MID, GENRE
HAVING COUNT(*) > 1;

-- TAGS HAS NO DUPLICATES
SELECT MID, TID
FROM TAGS
GROUP BY MID, TID
HAVING COUNT(*) > 1;

-- TAG_NAMES HAS NO DUPLICATES
SELECT TID, TAG
FROM TAG_NAMES
GROUP BY TID, TAG
HAVING COUNT(*) > 1;

--LIST OF TABLE THAT HAVE DUPLICATES
-- 1. MOVIES

CREATE VIEW MOVIES_NO_DUPLICATE AS
SELECT * 
FROM ((
    SELECT  TITLE, YEAR, RATING, NUM_RATING FROM MOVIES
        MINUS
    SELECT TITLE, YEAR, RATING, NUM_RATING FROM MOVIES
    GROUP BY TITLE, YEAR, RATING, NUM_RATING
    HAVING COUNT(*) > 1
    ) 
    UNION
SELECT TITLE, YEAR, RATING, NUM_RATING FROM MOVIES
GROUP BY TITLE, YEAR, RATING, NUM_RATING
HAVING COUNT(*) > 1
);
